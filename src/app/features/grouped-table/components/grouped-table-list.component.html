<div class="p-4">
  <!-- Header Section -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-gray-900">Sample Table with TanStack Grouping</h2>
    <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" class="w-80">
      <input
        nz-input
        placeholder="Search all columns..."
        [(ngModel)]="globalFilter"
        (ngModelChange)="table.setGlobalFilter($event)"
      />
    </nz-input-group>
    <ng-template #suffixIconButton>
      <button nz-button nzType="primary" nzSearch>
        <nz-icon nzType="search"></nz-icon>
      </button>
    </ng-template>
  </div>

  <!-- Drag and Drop Grouping Section -->
  <nz-card nzTitle="Drag & Drop Grouping" [nzExtra]="groupingExtra" class="mb-6">
    <ng-template #groupingExtra>
      <button
        nz-button
        nzType="link"
        nzSize="small"
        (click)="clearAllGrouping()"
        [disabled]="grouping().length === 0"
      >
        Clear All Groups
      </button>
    </ng-template>

    <!-- Drop Zone for Grouping -->
    <div
      class="border-2 border-dashed rounded-lg p-4 mb-4 transition-all duration-200 border-gray-300"
      [class.bg-gray-50]="grouping().length === 0"
      (dragover)="onDropZoneDragOver($event)"
      (drop)="onDropZoneDrop($event)"
    >
      @if (grouping().length === 0) {
        <div class="text-center text-gray-500 py-6">
          <nz-icon nzType="drag" class="text-2xl mb-2"></nz-icon>
          <p class="text-sm">Drag column headers here to group the table</p>
          <p class="text-xs text-gray-400">You can drag multiple columns to create multi-level grouping</p>
        </div>
      } @else {
        <div class="space-y-2">
          <h4 class="text-sm font-medium text-gray-700 mb-3">Active Groups (drag to reorder):</h4>
          <div
            class="flex flex-wrap gap-2 items-center min-h-[40px] p-2"
            cdkDropList
            [cdkDropListData]="grouping()"
            (cdkDropListDropped)="dropGrouping($event)"
            cdkDropListOrientation="horizontal"
          >
            @for (columnId of grouping(); track columnId; let i = $index) {
              <nz-tag
                nzColor="blue"
                class="cursor-move px-3 py-2 text-sm font-medium select-none"
                cdkDrag
                [cdkDragData]="columnId"
                [title]="'Group ' + (i + 1) + ': ' + getColumnHeader(columnId) + ' (drag to reorder)'"
                style="display: inline-flex; align-items: center; gap: 8px; white-space: nowrap;"
              >
                <span class="bg-blue-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs flex-shrink-0 font-medium leading-none">{{ i + 1 }}</span>
                <span class="flex-shrink-0">{{ getColumnHeader(columnId) }}</span>
                <button
                  class="text-blue-300 hover:text-white flex-shrink-0 cursor-pointer"
                  (click)="removeGrouping(columnId)"
                  title="Remove grouping"
                >
                  <nz-icon nzType="close" nzTheme="outline"></nz-icon>
                </button>

                <!-- CDK Drag Preview Template -->
                <div *cdkDragPreview class="drag-preview-template">
                  <nz-tag
                    nzColor="blue"
                    class="px-3 py-2 text-sm font-medium"
                    style="display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; border: 2px dashed #3b82f6; background-color: rgba(59, 130, 246, 0.1); opacity: 0.8;"
                  >
                    <span class="bg-blue-400 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs flex-shrink-0 font-medium leading-none">{{ i + 1 }}</span>
                    <span class="flex-shrink-0">{{ getColumnHeader(columnId) }}</span>
                    <span class="text-blue-200 flex-shrink-0">
                      <nz-icon nzType="close" nzTheme="outline"></nz-icon>
                    </span>
                  </nz-tag>
                </div>

                <!-- CDK Drag Placeholder Template -->
                <div *cdkDragPlaceholder class="drag-placeholder-template">
                  <div class="w-20 h-8 bg-blue-100 border-2 border-dashed border-blue-300 rounded"></div>
                </div>
              </nz-tag>
            }
          </div>
          <div class="mt-3 text-xs text-gray-500">
            ðŸ’¡ Drag groups to reorder them, or drag column headers from the table to add more groups
          </div>
        </div>
      }
    </div>

  </nz-card>

  <!-- Main Table Section using Ng-Zorro -->
  <nz-card>
    <nz-table
      #nzTable
      [nzData]="table.getRowModel().rows"
      [nzLoading]="loading"
      [nzShowPagination]="false"
      [nzScroll]="{ x: '1200px' }"
      nzSize="middle"
      [nzPageSize]="1000"
    >
      <thead>
        <tr>
          @for (header of table.getLeafHeaders(); track header.id) {
            <th
              [nzShowSort]="header.column.getCanSort()"
              [nzSortFn]="true"
              (nzSortOrderChange)="onSort(header.column, $event)"
              class="text-left font-semibold"
            >
              <div class="flex items-center space-x-2">
                @if (header.column.getCanGroup()) {
                  <div
                    class="flex items-center space-x-1 cursor-move px-2 py-1 rounded transition-colors hover:bg-gray-100 draggable-header"
                    draggable="true"
                    (dragstart)="onColumnDragStart($event, header.column.id)"
                    [title]="'Drag to group by ' + header.column.columnDef.header"
                  >
                    <nz-icon nzType="drag" class="text-gray-400 text-xs"></nz-icon>
                    <ng-container
                      *flexRender="
                        header.column.columnDef.header;
                        props: header.getContext();
                        let headerValue
                      "
                    >
                      <span class="font-semibold select-none">{{ headerValue }}</span>
                    </ng-container>
                    @if (header.column.getIsGrouped()) {
                      <span class="bg-blue-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs ml-1 font-medium leading-none min-w-[16px] min-h-[16px]">
                        {{ header.column.getGroupedIndex() + 1 }}
                      </span>
                    }
                  </div>
                } @else {
                  <ng-container
                    *flexRender="
                      header.column.columnDef.header;
                      props: header.getContext();
                      let headerValue
                    "
                  >
                    <span class="font-semibold">{{ headerValue }}</span>
                  </ng-container>
                }
              </div>
            </th>
          }
        </tr>
      </thead>
      <tbody>
        @for (row of table.getRowModel().rows; track row.id) {
          <tr
            [class.bg-blue-50]="row.getIsGrouped()"
            [class.font-semibold]="row.getIsGrouped()"
          >
            @for (cell of row.getVisibleCells(); track cell.id) {
              <td
                [class.pl-4]="!row.getIsGrouped() && cell.column.id === table.getAllLeafColumns()[0].id"
                [class.grouped-cell]="cell.getIsGrouped()"
                [style.padding-left.rem]="row.getIsGrouped() ? row.depth * 2 + 1 : undefined"
                class="align-top"
              >
                @if (cell.getIsGrouped()) {
                  <!-- Grouped Cell -->
                  <div class="flex items-start space-x-2 min-w-0">
                    <button
                      nz-button
                      nzType="text"
                      nzSize="small"
                      (click)="row.toggleExpanded()"
                      class="p-1 flex-shrink-0"
                    >
                      <nz-icon
                        [nzType]="row.getIsExpanded() ? 'minus-square' : 'plus-square'"
                        class="text-blue-600"
                      ></nz-icon>
                    </button>
                    <div class="flex flex-wrap items-center gap-2 min-w-0 flex-1">
                      <ng-container
                        *flexRender="
                          cell.column.columnDef.cell;
                          props: cell.getContext();
                          let cellValue
                        "
                      >
                        <nz-tag nzColor="blue" class="font-medium max-w-xs truncate">
                          <span [title]="cellValue" class="block truncate">{{ cellValue }}</span>
                        </nz-tag>
                      </ng-container>
                      <span class="text-sm text-gray-600 whitespace-nowrap">
                        ({{ row.subRows.length }} {{ row.subRows.length === 1 ? 'item' : 'items' }})
                      </span>
                    </div>
                  </div>
                } @else if (cell.getIsAggregated()) {
                  <!-- Aggregated Cell -->
                  <ng-container
                    *flexRender="
                      cell.column.columnDef.aggregatedCell ?? cell.column.columnDef.cell;
                      props: cell.getContext();
                      let aggregatedValue
                    "
                  >
                    <span class="font-medium text-orange-700">{{ aggregatedValue }}</span>
                  </ng-container>
                } @else if (cell.getIsPlaceholder()) {
                  <!-- Placeholder Cell -->
                  <span class="text-gray-400 italic">-</span>
                } @else {
                  <!-- Regular Cell -->
                  <ng-container [ngSwitch]="cell.column.id">
                    <nz-tag
                      *ngSwitchCase="'status'"
                      [nzColor]="getStatusColor(cell)"
                    >
                      {{ cell.getValue() }}
                    </nz-tag>
                    <ng-container *ngSwitchDefault>
                      <ng-container
                        *flexRender="
                          cell.column.columnDef.cell;
                          props: cell.getContext();
                          let cellValue
                        "
                      >
                        {{ cellValue }}
                      </ng-container>
                    </ng-container>
                  </ng-container>
                }
              </td>
            }
          </tr>
        }
      </tbody>
    </nz-table>

    <!-- Table Footer with Stats -->
    <nz-divider></nz-divider>
    <div class="flex justify-between items-center text-sm text-gray-600">
      <span>
        Showing {{ table.getRowModel().rows.length }} rows
        @if (grouping().length > 0) {
          | Grouped by {{ grouping().length }} column{{ grouping().length > 1 ? 's' : '' }}
        }
      </span>
      <div class="flex space-x-4">
        <span>Total Data: {{ data.length }}</span>
        @if (grouping().length > 0) {
          <span>Groups: {{ table.getGroupedRowModel().rows.length }}</span>
        } @else {
          <span>Groups: 0</span>
        }
      </div>
    </div>

    <div class="mt-4 text-sm text-gray-600">
      <strong>Drag & Drop Instructions:</strong>
      Drag column headers (with <nz-icon nzType="drag" class="inline text-xs"></nz-icon> icon) to the drop zone above to group by that column.
      Drag groups in the drop zone to reorder them or click âœ• to remove.
      Use âž•/âž– buttons to expand/collapse grouped rows.
      Try dragging Department, then Status for multi-level grouping.
    </div>
  </nz-card>
</div>

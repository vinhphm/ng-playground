<div class="p-4">
  <!-- Header Section -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-gray-900">Sample Table with TanStack Grouping</h2>
    <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" class="w-80">
      <input
        nz-input
        placeholder="Search all columns..."
        [(ngModel)]="globalFilter"
        (ngModelChange)="table.setGlobalFilter($event)"
      />
    </nz-input-group>
    <ng-template #suffixIconButton>
      <button nz-button nzType="primary" nzSearch>
        <nz-icon nzType="search"></nz-icon>
      </button>
    </ng-template>
  </div>

  <!-- Grouping Control Section -->
  <nz-card nzTitle="Column Grouping Controls" [nzExtra]="groupingExtra" class="mb-6">
    <ng-template #groupingExtra>
      <button 
        nz-button 
        nzType="link" 
        nzSize="small"
        (click)="clearAllGrouping()"
        [disabled]="grouping().length === 0"
      >
        Clear All Groups
      </button>
    </ng-template>

    <div class="mb-4">
      <h4 class="text-sm font-medium text-gray-700 mb-2">Available Grouping Actions:</h4>
      <nz-space nzWrap>
        @for (header of table.getLeafHeaders(); track header.id) {
          @if (header.column.getCanGroup()) {
            <button
              *nzSpaceItem
              nz-button
              [nzType]="header.column.getIsGrouped() ? 'primary' : 'default'"
              nzSize="small"
              (click)="header.column.toggleGrouping()"
              [title]="header.column.getIsGrouped() ? 'Click to ungroup' : 'Click to group by ' + header.column.columnDef.header"
            >
              @if (header.column.getIsGrouped()) {
                <span>ðŸ›‘ {{ header.column.columnDef.header }} ({{ header.column.getGroupedIndex() }})</span>
              } @else {
                <span>ðŸ‘Š {{ header.column.columnDef.header }}</span>
              }
            </button>
          }
        }
      </nz-space>
    </div>

    @if (grouping().length > 0) {
      <div class="mt-3">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Current Grouping:</h4>
        <pre class="bg-gray-100 p-2 rounded text-xs max-h-20 overflow-y-auto">{{ stringifiedGrouping() }}</pre>
      </div>
    }
  </nz-card>

  <!-- Main Table Section using Ng-Zorro -->
  <nz-card>
    <nz-table
      #nzTable
      [nzData]="table.getRowModel().rows"
      [nzLoading]="loading"
      [nzShowPagination]="false"
      [nzScroll]="{ x: '1200px' }"
      nzSize="middle"
      [nzPageSize]="1000"
    >
      <thead>
        <tr>
          @for (header of table.getLeafHeaders(); track header.id) {
            <th 
              [nzShowSort]="header.column.getCanSort()"
              [nzSortFn]="true"
              (nzSortOrderChange)="onSort(header.column, $event)"
              class="text-left font-semibold"
            >
              <div class="flex items-center space-x-2">
                @if (header.column.getCanGroup()) {
                  <button
                    nz-button
                    nzType="text"
                    nzSize="small"
                    (click)="header.column.toggleGrouping()"
                    [title]="header.column.getIsGrouped() ? 'Ungroup' : 'Group by ' + header.column.columnDef.header"
                    class="flex items-center p-0"
                  >
                    @if (header.column.getIsGrouped()) {
                      <span class="text-blue-600 text-xs">ðŸ›‘{{ header.column.getGroupedIndex() }}</span>
                    } @else {
                      <span class="text-gray-500 hover:text-blue-600 text-xs">ðŸ‘Š</span>
                    }
                  </button>
                }
                <ng-container
                  *flexRender="
                    header.column.columnDef.header;
                    props: header.getContext();
                    let headerValue
                  "
                >
                  <span class="font-semibold">{{ headerValue }}</span>
                </ng-container>
              </div>
            </th>
          }
        </tr>
      </thead>
      <tbody>
        @for (row of table.getRowModel().rows; track row.id) {
          <tr 
            [class.bg-blue-50]="row.getIsGrouped()"
            [class.font-semibold]="row.getIsGrouped()"
          >
            @for (cell of row.getVisibleCells(); track cell.id) {
              <td 
                [class.pl-4]="!row.getIsGrouped() && cell.column.id === table.getAllLeafColumns()[0].id"
                [class.grouped-cell]="cell.getIsGrouped()"
                [style.padding-left.rem]="row.getIsGrouped() ? row.depth * 2 + 1 : undefined"
                class="align-top"
              >
                @if (cell.getIsGrouped()) {
                  <!-- Grouped Cell -->
                  <div class="flex items-start space-x-2 min-w-0">
                    <button
                      nz-button
                      nzType="text"
                      nzSize="small"
                      (click)="row.toggleExpanded()"
                      class="p-1 flex-shrink-0"
                    >
                      <nz-icon 
                        [nzType]="row.getIsExpanded() ? 'minus-square' : 'plus-square'"
                        class="text-blue-600"
                      ></nz-icon>
                    </button>
                    <div class="flex flex-wrap items-center gap-2 min-w-0 flex-1">
                      <ng-container
                        *flexRender="
                          cell.column.columnDef.cell;
                          props: cell.getContext();
                          let cellValue
                        "
                      >
                        <nz-tag nzColor="blue" class="font-medium max-w-xs truncate">
                          <span [title]="cellValue" class="block truncate">{{ cellValue }}</span>
                        </nz-tag>
                      </ng-container>
                      <span class="text-sm text-gray-600 whitespace-nowrap">
                        ({{ row.subRows.length }} {{ row.subRows.length === 1 ? 'item' : 'items' }})
                      </span>
                    </div>
                  </div>
                } @else if (cell.getIsAggregated()) {
                  <!-- Aggregated Cell -->
                  <ng-container
                    *flexRender="
                      cell.column.columnDef.aggregatedCell ?? cell.column.columnDef.cell;
                      props: cell.getContext();
                      let aggregatedValue
                    "
                  >
                    <span class="font-medium text-orange-700">{{ aggregatedValue }}</span>
                  </ng-container>
                } @else if (cell.getIsPlaceholder()) {
                  <!-- Placeholder Cell -->
                  <span class="text-gray-400 italic">-</span>
                } @else {
                  <!-- Regular Cell -->
                  <ng-container [ngSwitch]="cell.column.id">
                    <nz-tag
                      *ngSwitchCase="'status'"
                      [nzColor]="getStatusColor(cell)"
                    >
                      {{ cell.getValue() }}
                    </nz-tag>
                    <ng-container *ngSwitchDefault>
                      <ng-container
                        *flexRender="
                          cell.column.columnDef.cell;
                          props: cell.getContext();
                          let cellValue
                        "
                      >
                        {{ cellValue }}
                      </ng-container>
                    </ng-container>
                  </ng-container>
                }
              </td>
            }
          </tr>
        }
      </tbody>
    </nz-table>

    <!-- Table Footer with Stats -->
    <nz-divider></nz-divider>
    <div class="flex justify-between items-center text-sm text-gray-600">
      <span>
        Showing {{ table.getRowModel().rows.length }} rows
        @if (grouping().length > 0) {
          | Grouped by {{ grouping().length }} column{{ grouping().length > 1 ? 's' : '' }}
        }
      </span>
      <div class="flex space-x-4">
        <span>Total Data: {{ data.length }}</span>
        @if (grouping().length > 0) {
          <span>Groups: {{ table.getGroupedRowModel().rows.length }}</span>
        } @else {
          <span>Groups: 0</span>
        }
      </div>
    </div>

    <div class="mt-4 text-sm text-gray-600">
      <strong>Instructions:</strong> 
      Click ðŸ‘Š buttons to group by columns, ðŸ›‘ to ungroup. 
      Use âž•/âž– buttons to expand/collapse grouped rows.
      Try grouping by Department, then by Status for multi-level grouping.
    </div>
  </nz-card>
</div>